<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Treatment and Condition Connections</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet">
  <style>
    #related-posts-graph-container {
      position: relative;
      background-color: black;
      margin: 0 auto;
      width: 100%;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #related-posts-graph {
      height: 500px;
      width: 100%;
    }

    .expand-button {
      background-color: blue;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div id="related-posts-graph-container">
  <div id="related-posts-graph"></div>
  <button id="expandButton" class="expand-button">Full Screen</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  function calculateCircularPositions(nodes, radius) {
    const angleStep = (2 * Math.PI) / nodes.length;
    return nodes.map((node, index) => {
      const angle = angleStep * index;
      return {
        ...node,
        x: radius * Math.cos(angle),
        y: radius * Math.sin(angle)
      };
    });
  }

  var nodes = [
    <?php foreach ($related_posts as $related_post) { ?>
      {
        id: <?php echo $related_post->ID; ?>,
        label: <?php echo json_encode(esc_js(get_the_title($related_post->ID))); ?>,
        url: <?php echo json_encode(esc_js(get_permalink($related_post->ID))); ?>
      },
    <?php } ?>
  ];

  // Calculate circular positions for initial load
  nodes = calculateCircularPositions(nodes, 200);

  var edges = [
    <?php foreach ($connections as $connection) { ?>
      { from: <?php echo $connection['from']; ?>, to: <?php echo $connection['to']; ?> },
    <?php } ?>
  ];

  var container = document.getElementById("related-posts-graph");

  var data = {
    nodes: new vis.DataSet(nodes),
    edges: new vis.DataSet(edges)
  };

  var options = {
    layout: {
      improvedLayout: false // Disable forceAtlas2-based layout by default
    },
    physics: {
      enabled: <?php echo $atts['physics'] === 'on' ? 'true' : 'false'; ?>,
      solver: 'forceAtlas2Based',
      stabilization: {
        enabled: true,
        iterations: 200
      }
    },
    interaction: {
      zoomView: true,
      dragNodes: true
    },
    nodes: {
      color: '#fff',
      font: {
        color: '#ffffff'
      },
      size: 12,
      shape: 'dot',
      fixed: {
        x: false,
        y: false
      }
    },
    manipulation: {
      enabled: false
    }
  };

  var network = new vis.Network(container, data, options);

  // Add the toggle physics button on top of the graph
  var togglePhysicsButton = document.createElement('button');
  togglePhysicsButton.innerHTML = 'Toggle Physics';
  togglePhysicsButton.style.position = 'absolute';
  togglePhysicsButton.style.top = '10px';
  togglePhysicsButton.style.left = '10px';
  togglePhysicsButton.style.zIndex = '10';
  togglePhysicsButton.style.padding = '5px 10px';
  togglePhysicsButton.style.backgroundColor = '#333';
  togglePhysicsButton.style.color = '#fff';
  togglePhysicsButton.style.border = 'none';
  togglePhysicsButton.style.cursor = 'pointer';
  container.appendChild(togglePhysicsButton);

  togglePhysicsButton.addEventListener("click", function () {
    const isPhysicsEnabled = options.physics.enabled;
    options.physics.enabled = !isPhysicsEnabled;
    network.setOptions(options);

    if (!options.physics.enabled) {
      // When physics is disabled, maintain the circular layout
      const updatedNodes = calculateCircularPositions(nodes, 200);
      data.nodes.update(updatedNodes);
    }
  });

  // Adjust network to handle stabilization and physics settings
  network.on("stabilizationIterationsDone", function () {
    if (!options.physics.enabled) {
      const updatedNodes = calculateCircularPositions(nodes, 200);
      data.nodes.update(updatedNodes);
    }
  });

  // Zoom Controls (optional, can be removed if not needed)
  var currentZoom = 1;
  document.getElementById("zoomInButton").addEventListener("click", function () {
    currentZoom += 0.2;
    network.setOptions({
      interaction: {
        zoomSpeed: 1.5
      }
    });
    network.moveTo({ scale: currentZoom });
  });

  document.getElementById("zoomOutButton").addEventListener("click", function () {
    currentZoom -= 0.2;
    network.setOptions({
      interaction: {
        zoomSpeed: 1.5
      }
    });
    network.moveTo({ scale: currentZoom });
  });

});

</script>

</body>
</html>
